# EdgeXFoundry Proxy setup

Kong is initalized using the security-proxy-setup oneshot daemon.

Its configuration.toml file contains a KongAuth section:

```
[KongAuth]
Name = "oauth2"
TokenTTL = 0
Resource = "coredata"
OutputPath = "accessToken.json"
```
*Name* can be either oauth2 or jwt. Based on that setting, Kong will be initialized to use either of the two authentication methods.

## OAuth 2.0

OAuth2 is implemented in Kong using the [OAuth 2.0 plugin](https://docs.konghq.com/hub/kong-inc/oauth2/)

The OAuth2 implementation uses the [Client Credentials flow](https://tools.ietf.org/html/rfc6749#section-4.4). In that, the token is generated in two steps
1. The user is created with associated client_id and client_secret values, which can either be specified or generated by the plugin.
2. The client_id and client_secret values are then used to authorize with the authorization server (the Kong plugin) and request an access token from the token endpoint.



### Step 1 - Enabling the plugin globally

As per [Kong docs](https://docs.konghq.com/hub/kong-inc/oauth2/#enabling-the-plugin-globally), security-proxy-setup will enable the plugin globally

This is done in [service.go](https://github.com/edgexfoundry/edgex-go/blob/4a93de6e2e8f65a45d7e1065c78fcf8c18a7addf/internal/security/proxy/service.go#L480) and that effectively does the same as

```
$ curl -X POST http://localhost:8001/plugins/ \
    --data "name=oauth2"  \
    --data "config.scopes=all" \
    --data "config.mandatory_scope=true" \
    --data "config.enable_client_credentials=true" \
    --data "config.global_credentials=true" \
    --data "config.refresh_token_ttl=0" 


```

This is a required step before OAuth2 can be used and is why KongAuth.Name must be set to the correct value before EdgeXFoundry starts up.

### Step 2 - Creating a user and an OAuth application

In order to use the plugin, you first need to [create a consumer](https://docs.konghq.com/hub/kong-inc/oauth2/#create-a-consumer) to associate one or more credentials to. This is done with

```
$ edgexfoundry.secrets-config proxy adduser --token-type oauth2 --user user123
```

which under the covers does

```
curl -X POST http://localhost:8001/consumers/ \
    --data "username=user123" 
```

The proxy adduser command also [creates an OAuth application](https://docs.konghq.com/hub/kong-inc/oauth2/#create-an-application) by making the following HTTP request

```
curl -X POST http://kong:8001/consumers/user123/oauth2 \
    --data "name=user123" \
    --data "redirect_uris=https://localhost" 

```

Note that the OAuth plugin allows the user to also specify

```
  --data "client_id=SOME-CLIENT-ID" \
  --data "client_secret=SOME-CLIENT-SECRET" \
```

but secrets-config doesn't - so that the plugin will **generate the values.**

The result from the curl command will look like

```
{"redirect_uris":["https:\/\/localhost"],"created_at":1617983665,"consumer":{"id":"d1319ce4-6659-45f5-9e46-3de88f8a6420"},"id":"f587e6e2-8b7f-4426-83f2-14bfc10afae8","tags":null,"name":"user123","client_secret":"exaMqkNJuW2JaHd27U9B7XfFR9vNHXEe","client_id":"vHvlYpl0CMPQSBhZEEcSuXUmXpEB1Q6V"}
```

and the secrets-config command will print out the generated client_secret and client_id values


This is different from the original security-proxy-setup command which set the secret and id to be the same as the username, using

```
curl -X POST "http://localhost:8001/consumers/user123/oauth2" -d "name=www.edgexfoundry.org" --data "client_id=user123" -d "client_secret=user123"  -d "redirect_uri=http://www.edgexfoundry.org/"
```


### Step 3 - Get token

Once the user (consumer) and application have been set up, the final step is to get the token.

Do this using

```
edgexfoundry.secrets-config proxy oauth2 --client_id <clientid> --client_secret <clientsecret>
```

which is implemented in [command.go](https://github.com/edgexfoundry/edgex-go/blob/master/internal/security/config/command/proxy/oauth2/command.go) in the security-config application, which basically does

```
curl -k https://localhost:8443/coredata/oauth2/token -d "grant_type=client_credentials" -d "scope=" -d "client_id=<clientid>" -d "client_secret=<clientsecret>"
```

That returns the token to use to authenticate.

More information about the issued tokens can be retrieved using

```
curl -sX GET http://localhost:8001/oauth2_tokens/ | jq
```

```
  "data": [
    {
      "created_at": 1617985684,
      "id": "28adfba8-a16c-44bb-ad0c-9bb31fd92cdd",
      "scope": null,
      "authenticated_userid": null,
      "refresh_token": null,
      "expires_in": 7200,
      "access_token": "Hb1JtlNfGB5wAi3Wiz7xwF91heWA0hEI",
      "token_type": "bearer",
      "credential": {
        "id": "1942ec20-032a-4e84-8b5a-345a7d43d25a"
      },
      "ttl": null,
      "service": null
    },
```

The resulting token can then be used to access EdgeXFoundry via Kong:

```
curl -k -X GET https://localhost:8443/coredata/api/v1/ping? -H "Authorization: Bearer Hb1JtlNfGB5wAi3Wiz7xwF91heWA0hEI"
```

### Issues:

- The generated tokens are set to expire in 7200 seconds / 2 hours, which is the default value. This is because the plugin initialiation in step 1 does not set 

```
   --data "config.token_expiration=7200" \
```

Default value: 7200	
An optional integer value telling the plugin how many seconds a token should last, after which the client will need to refresh the token. Set to 0 to disable the expiration.


but instead sets

```
--data "config.refresh_token_ttl=0" 
```    
 An optional integer value telling the plugin how many seconds a token/refresh token pair is valid for, and can be used to generate a new access token. Default value is 2 weeks. Set to 0 to keep the token/refresh token pair valid indefinitely.
 
We do not have a renew token so after 2 hours we need to use the same client_id and client_secret values as before to request a new token, as described step 3.
   

## JWT


### Step 1 - Enabling the plugin globally

As per [JWT Kong plugin documentation](https://docs.konghq.com/hub/kong-inc/jwt/), security-proxy-setup will enable the plugin globally

This is done in [service.go](https://github.com/edgexfoundry/edgex-go/blob/4a93de6e2e8f65a45d7e1065c78fcf8c18a7addf/internal/security/proxy/service.go#L447) and that effectively does the same as

```
$ curl -X POST http://localhost:8001/plugins/ --data "name=jwt" 
```

This is a required step before JWT can be used and is why KongAuth.Name must be set to the correct value before EdgeXFoundry starts up.


### Step 2 - Creating a user 

In order to use the plugin, you first need to [create a consumer](https://docs.konghq.com/hub/kong-inc/jwt/#create-a-consumer) to associate one or more credentials to. 

You need to provide the following
- The username
- The public key
- (optionally) ID. This is a unique string identifying the credential. It will be required in the next step to create the JWT token. If you don't specify it, then the JWT Kong plugin will generate one. 

Adding a user is done with

```
# Create private key:
$ openssl ecparam -genkey -name prime256v1 -noout -out private.pem

# Create public key:
$ openssl ec -in private.pem -pubout -out public.pem

# create ID
$ edgexfoundry.secrets-config proxy adduser --token-type jwt --user user01 --algorithm ES256 --public_key public.pem --id USER_ID_KEY_VALUE

```

The secrets-config command is essentially doing the equivalent of:

```
curl -X POST http://localhost:8001/consumers/ \
    --data "username=user01" 

# use RS256 or ES256
curl -X POST http://localhost:8001/consumers/user01/jwt \
    --data "algorithm=ES256" \
    -- data "rsa_public_key=a36c3049b36249a3c9f8891cb127243c"    
```


### Step 3 - Get token

To generate a token, you need two things
- The private key matching the public key used to create the user in Step 2
- The unique ID for the user. If you specified a value for ID in Step 2, then use that. Otherwise use the one printed out when the user was added. Alternatively you can get the ID value by doing

```
curl -X GET http://localhost:8001/consumers/user01/jwt | jq
```

The token is created without needing a connection to Kong or the EdgeX installation and can therefore be generated on a different computer.

secrets-config provides a method to create a token for you:

```
$ edgexfoundry.secrets-config proxy jwt --algorithm ES256 --private_key private.pem --id USER_ID_KEY_VALUE --expiration=1h
```

However, you can also do this with different tools. To create a token using a bash script do the following.

```
# set alg to RS256 or ES256
# get the encoded header

header='{
    "alg": "ES256",
    "typ": "JWT"
}'

JWT_HEADER=`echo -n $header | base64 | sed s/\+/-/ | sed -E s/=+$//`
TTL=$((EPOCHSECONDS+3600))

# This can either be the value we specified - or if we didn't specify one, then it's the autogenerated key
USER_KEY="USER_ID_KEY_VALUE"

payload='{
    "iss":"'$USER_KEY'",
    "iat":'$EPOCHSECONDS', 
    "nbf":'$EPOCHSECONDS',
    "exp":'$TTL' 
}'

JWT_PAYLOAD=`echo -n $payload | base64 | sed s/\+/-/ | sed -E s/=+$//`
JWT_SIGNATURE=`echo -n "$JWT_HEADER.$JWT_PAYLOAD" | openssl dgst -sha256 -binary -sign private.pem  | openssl enc -base64 | tr -d '\n=' | tr -- '+/' '-_'`
TOKEN=$JWT_HEADER.$JWT_PAYLOAD.$JWT_SIGNATURE

```
once you have the token, you can validate it on [jwt.io](https://jwt.io/#debugger-io)


### Step 3 - Test token

Using the JWT token from step 3, execute an EdgeX command:

```

# ping
curl -k -X GET https://localhost:8443/coredata/api/v1/ping? -H "Authorization: Bearer $TOKEN"


```




